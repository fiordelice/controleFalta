<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Faltas e Justificativas</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    header h1 {
      font-weight: 700;
      color: #2c3e50;
    }
    form {
      max-width: 900px;
      margin: 0 auto 40px auto;
      background: white;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    form label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }
    /* Botões na linha de edição */
.btn-edit,
.btn-save,
.btn-cancel {
  padding: 6px 14px;
  margin-right: 10px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  min-width: 80px;
  transition: background-color 0.3s;
}

.btn-edit {
  background-color: #6473ff;
  color: white;
  border: none;
}
.btn-edit:hover {
  background-color: #4b5ecc;
}

.btn-save {
  background-color: #27ae60;
  color: white;
  border: none;
}
.btn-save:hover {
  background-color: #219150;
}

.btn-cancel {
  background-color: #95a5a6;
  color: white;
  border: none;
}
.btn-cancel:hover {
  background-color: #7f8c8d;
}

    form input[type="text"],
    form input[type="date"],
    form select,
    form textarea {
      width: 100%;
      padding: 8px 10px;
      margin-top: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }
    form textarea {
      resize: vertical;
    }
    form .flex-row {
      display: flex;
      gap: 15px;
    }
    form .flex-row > div {
      flex: 1;
    }
    form button {
      margin-top: 25px;
      background: #27ae60;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      transition: background 0.3s;
    }
    form button:hover {
      background: #219150;
    }
    #alertMessage {
      color: red;
      font-weight: 700;
      margin-top: 10px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    .filter-section {
      margin-bottom: 30px;
      text-align: center;
    }
    .filter-section input {
      padding: 8px 12px;
      font-size: 16px;
      width: 200px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .filter-section button {
      margin-left: 10px;
      padding: 9px 18px;
      font-weight: 700;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #2980b9;
      color: white;
      transition: background 0.3s;
    }
    .filter-section button:hover {
      background-color: #1c5d85;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 0 12px rgba(0,0,0,0.05);
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 14px 18px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      font-size: 14px;
    }
    th {
      background-color: #34495e;
      color: white;
      font-weight: 700;
    }
    tbody tr:hover {
      background-color: #f1f7fc;
    }
    .btn-export-month {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-export-month:hover {
      background-color: #2c80b4;
    }
    .btn-export-all {
      margin-top: 10px;
      background-color: #e67e22;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      display: block;
      width: 180px;
      margin-left: auto;
    }
    .btn-export-all:hover {
      background-color: #cf6f1f;
    }
    .alert-warning {
      background-color: #ffcccc;
      border-left: 6px solid #e74c3c;
      padding: 10px 15px;
      margin: 20px 0;
      font-weight: 700;
      color: #b03a2e;
      border-radius: 4px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    .btn-edit {
      background-color: #6473ff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-edit:hover {
      background-color: #6473ff;
    }
    .btn-delete {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-delete:hover {
      background-color: #c0392b;
    }
  </style>
</head>
<body>
  <header>
    <h1>Controle de Faltas e Justificativas</h1>
  </header>
  <main class="container">
    <form id="formRegistro">
      <div class="flex-row">
        <div>
          <label for="name">Nome Completo:</label>
          <input type="text" id="name" required />
        </div>
        <div>
          <label for="cs">CS:</label>
          <input type="text" id="cs" required />
        </div>
      </div>

      <label for="date">Data da Ocorrência:</label>
      <input type="date" id="date" required />

      <div class="flex-row">
        <div>
          <label for="entrada">Entrada:</label>
          <input type="text" id="entrada" placeholder="Ex: 08:00" />
        </div>
        <div>
          <label for="saida">Saída:</label>
          <input type="text" id="saida" placeholder="Ex: 17:30" />
        </div>
      </div>

      <div class="flex-row">
        <div>
          <label for="atestado">Atestado:</label>
          <select id="atestado" required>
            <option value="Não">Não</option>
            <option value="Sim">Sim</option>
          </select>
        </div>
        <div>
          <label for="motivo">Motivo (se houver):</label>
          <textarea id="motivo" rows="2" placeholder="Descreva o motivo da falta ou justificativa"></textarea>
        </div>
      </div>

      <button type="submit">Registrar Ocorrência</button>
      <p id="alertMessage"></p>
    </form>

    <div class="filter-section">
      <input type="text" id="filterCS" placeholder="Digite CS para filtrar faltas sem justificativa" />
      <button id="btnFilter">Filtrar</button>
    </div>

    <table id="registrosTable" aria-label="Tabela de registros">
      <thead>
        <tr>
          <th>Nome</th>
          <th>CS</th>
          <th>Data Ocorrência</th>
          <th>Entrada</th>
          <th>Saída</th>
          <th>Atestado</th>
          <th>Motivo</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="8" style="text-align:right;">
            <button class="btn-export-all" id="exportAllBtn">Exportar Excel (Ano Completo)</button>
          </td>
        </tr>
      </tfoot>
    </table>
  </main>

  <div id="alertWarning" class="alert-warning" style="display:none;"></div>

  <!-- Bibliotecas externas -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <script>
    // Configuração Firebase (seus dados)
    const firebaseConfig = {
      apiKey: "AIzaSyBdvUidNk2NewiYxTqSPEyxCDpCGpCgvNQ",
      authDomain: "controlefaltas-7cf63.firebaseapp.com",
      projectId: "controlefaltas-7cf63",
      storageBucket: "controlefaltas-7cf63.firebasestorage.app",
      messagingSenderId: "240078440869",
      appId: "1:240078440869:web:0daafd0f16acd183cfc04c",
      measurementId: "G-HSCWY7DCB1"
    };

    // Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();

    const formRegistro = document.getElementById('formRegistro');
    const alertMessage = document.getElementById('alertMessage');
    const registrosTableBody = document.querySelector('#registrosTable tbody');
    const filterCSInput = document.getElementById('filterCS');
    const btnFilter = document.getElementById('btnFilter');
    const alertWarning = document.getElementById('alertWarning');
    const exportAllBtn = document.getElementById('exportAllBtn');

    // Formata data dd/mm/aaaa para yyyy-mm-dd (input date)
    function formatDateForInput(dateStr) {
      const parts = dateStr.split('/');
      if(parts.length !== 3) return '';
      return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
    }

    // Formata data para dd/mm/aaaa
    function formatarData(date) {
      if (!date) return '';
      if (typeof date === 'string' && date.includes('-')) {
        const [ano, mes, dia] = date.split('-');
        return `${dia}/${mes}/${ano}`;
      }
      if (typeof date === 'string' && date.includes('/')) {
        return date;
      }
      if (date instanceof Date) {
        const d = date.getDate().toString().padStart(2, '0');
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
      }
      return '';
    }

    // Agrupa registros por mês/ano "MM/YYYY"
    function agruparPorMes(registros) {
      return registros.reduce((acc, reg) => {
        let data = reg.date;
        if (typeof data === 'string') {
          // Tenta converter para Date
          const partes = data.split('-');
          if (partes.length === 3) {
            data = new Date(data);
          }
        }
        const d = new Date(data);
        if (isNaN(d)) return acc;
        const mesAno = `${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
        if (!acc[mesAno]) acc[mesAno] = [];
        acc[mesAno].push(reg);
        return acc;
      }, {});
    }

    // Carrega registros do Firestore e renderiza tabela
    async function carregarRegistros() {
      try {
        alertWarning.style.display = 'none';
        const snapshot = await db.collection('registros').orderBy('date', 'desc').get();
        const registros = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        renderTable(registros);
        checkWarnings(registros);
      } catch (error) {
        console.error('Erro ao carregar registros:', error);
        alertMessage.textContent = 'Erro ao carregar registros.';
        alertMessage.style.color = 'red';
      }
    }

    // Renderiza tabela com registros
   function renderTable(dados, filtros = '') {
  registrosTableBody.innerHTML = '';

  const filtroCS = filtros || filterCSInput.value;
  const filteredRegs = dados.filter(reg => !filtroCS || reg.cs.includes(filtroCS));

  const registrosAgrupados = agruparPorMes(filteredRegs);

  for (const mesAno in registrosAgrupados) {
    const trHeader = document.createElement('tr');
    const tdHeader = document.createElement('td');
    tdHeader.colSpan = 8;
    tdHeader.style.backgroundColor = '#2c3e50';
    tdHeader.style.color = 'white';
    tdHeader.style.fontWeight = 'bold';
    tdHeader.textContent = mesAno;
    trHeader.appendChild(tdHeader);
    registrosTableBody.appendChild(trHeader);

    registrosAgrupados[mesAno].forEach((reg, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${reg.name}</td>
        <td>${reg.cs}</td>
        <td>${formatarData(reg.date)}</td>
        <td>${reg.entrada || 'N/A'}</td>
        <td>${reg.saida || 'N/A'}</td>
        <td>${reg.atestado}</td>
        <td>${reg.motivo || 'N/A'}</td>
        <td><button class="btn-edit" onclick="editFirestoreRegistro('${reg.id}')">Editar</button></td>
      `;
      registrosTableBody.appendChild(tr);
    });
  }

  destacarFaltasSemJustificativa(filteredRegs);
}


    // Função para exibir alertas para faltas sem justificativas
    function checkWarnings(registros) {
      const faltasSemJustificativa = registros.filter(r =>
        (r.atestado === 'Não' || !r.atestado) &&
        (!r.motivo || r.motivo.trim() === '')
      );

      if (faltasSemJustificativa.length > 0) {
        alertWarning.style.display = 'block';
        alertWarning.textContent = `Existem ${faltasSemJustificativa.length} faltas sem justificativa ou atestado.`;
      } else {
        alertWarning.style.display = 'none';
      }
    }

    // Exportar Excel completo (ano inteiro)
    function exportarExcelCompleto() {
      db.collection('registros').get().then(snapshot => {
        const registros = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        exportarExcel(registros, 'Registros_Anual');
      });
    }

    // Exportar Excel por mês
    function exportarExcelPorMes(mesAno, dadosMes) {
      exportarExcel(dadosMes, `Registros_${mesAno.replace('/', '_')}`);
    }

    // Função exportar para Excel
    function exportarExcel(dados, nomeArquivo) {
      if (dados.length === 0) {
        alert('Nenhum registro para exportar.');
        return;
      }
      const wb = XLSX.utils.book_new();

      const ws_data = [
        ['Nome', 'CS', 'Data Ocorrência', 'Entrada', 'Saída', 'Atestado', 'Motivo']
      ];

      dados.forEach(reg => {
        ws_data.push([
          reg.name,
          reg.cs,
          formatarData(reg.date),
          reg.entrada || '',
          reg.saida || '',
          reg.atestado,
          reg.motivo || ''
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, 'Registros');
      XLSX.writeFile(wb, nomeArquivo + '.xlsx');
    }

    // Adicionar registro no Firestore
    async function adicionarRegistro(event) {
      event.preventDefault();
      alertMessage.textContent = '';

      const registro = {
        name: formRegistro.name.value.trim(),
        cs: formRegistro.cs.value.trim(),
        date: formRegistro.date.value,
        entrada: formRegistro.entrada.value.trim() || '',
        saida: formRegistro.saida.value.trim() || '',
        atestado: formRegistro.atestado.value,
        motivo: formRegistro.motivo.value.trim() || ''
      };

      if (!registro.name || !registro.cs || !registro.date || !registro.atestado) {
        alertMessage.textContent = 'Preencha todos os campos obrigatórios.';
        alertMessage.style.color = 'red';
        return;
      }

      try {
        await db.collection('registros').add(registro);
        alertMessage.textContent = 'Registro adicionado com sucesso!';
        alertMessage.style.color = 'green';
        formRegistro.reset();
        carregarRegistros();
      } catch (error) {
        console.error('Erro ao adicionar registro:', error);
        alertMessage.textContent = 'Erro ao adicionar registro.';
        alertMessage.style.color = 'red';
      }
    }

    // Atualizar registro no Firestore
    function updateFirestoreRegistro(docId, updatedData) {
      db.collection('registros').doc(docId).update(updatedData)
        .then(() => {
          alertMessage.textContent = 'Registro atualizado com sucesso!';
          alertMessage.style.color = 'green';
          carregarRegistros();
        })
        .catch(error => {
          console.error('Erro ao atualizar registro:', error);
          alertMessage.textContent = 'Erro ao atualizar registro.';
          alertMessage.style.color = 'red';
        });
    }

    // Excluir registro do Firestore
    function deleteFirestoreRegistro(docId) {
      if (!confirm('Tem certeza que deseja excluir este registro?')) return;

      db.collection('registros').doc(docId).delete()
        .then(() => {
          alertMessage.textContent = 'Registro excluído com sucesso!';
          alertMessage.style.color = 'green';
          carregarRegistros();
        })
        .catch(error => {
          console.error('Erro ao excluir registro:', error);
          alertMessage.textContent = 'Erro ao excluir registro.';
          alertMessage.style.color = 'red';
        });
    }

    // Começar edição inline
    function startEdit(docId, btn) {
      const tr = btn.closest('tr');
      const tds = tr.querySelectorAll('td');

      // Evitar abrir mais de uma edição ao mesmo tempo
      if (document.querySelector('tr.editing')) {
        alert('Finalize a edição atual antes de editar outro registro.');
        return;
      }
      tr.classList.add('editing');

      // Transforma células em inputs
      tds[0].innerHTML = `<input type="text" value="${tds[0].textContent}" style="width:100%"/>`;
      tds[1].innerHTML = `<input type="text" value="${tds[1].textContent}" style="width:100%"/>`;
      tds[2].innerHTML = `<input type="date" value="${formatDateForInput(tds[2].textContent)}" style="width:100%"/>`;
      tds[3].innerHTML = `<input type="text" value="${tds[3].textContent === 'N/A' ? '' : tds[3].textContent}" style="width:100%"/>`;
      tds[4].innerHTML = `<input type="text" value="${tds[4].textContent === 'N/A' ? '' : tds[4].textContent}" style="width:100%"/>`;
      tds[5].innerHTML = `
        <select style="width:100%">
          <option value="Não" ${tds[5].textContent === 'Não' ? 'selected' : ''}>Não</option>
          <option value="Sim" ${tds[5].textContent === 'Sim' ? 'selected' : ''}>Sim</option>
        </select>
      `;
      tds[6].innerHTML = `<textarea style="width:100%" rows="2">${tds[6].textContent === 'N/A' ? '' : tds[6].textContent}</textarea>`;

      // Botões salvar e cancelar
      tds[7].innerHTML = `
        <button style="background:#27ae60; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="saveEdit('${docId}', this)">Salvar</button>
        <button style="background:#95a5a6; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; margin-left:5px;" onclick="cancelEdit(this)">Cancelar</button>
      `;
    }

    // Salvar edição no Firestore
    function saveEdit(docId, btn) {
      const tr = btn.closest('tr');
      const inputs = tr.querySelectorAll('input, select, textarea');

      const updatedData = {
        name: inputs[0].value.trim(),
        cs: inputs[1].value.trim(),
        date: inputs[2].value,
        entrada: inputs[3].value.trim() || '',
        saida: inputs[4].value.trim() || '',
        atestado: inputs[5].value,
        motivo: inputs[6].value.trim() || ''
      };

      if (!updatedData.name || !updatedData.cs || !updatedData.date || !updatedData.atestado) {
        alertMessage.textContent = 'Campos obrigatórios não podem ficar vazios.';
        alertMessage.style.color = 'red';
        return;
      }

      updateFirestoreRegistro(docId, updatedData);
    }

    // Cancelar edição, recarregar tabela
    function cancelEdit(btn) {
      const tr = btn.closest('tr');
      tr.classList.remove('editing');
      carregarRegistros();
      alertMessage.textContent = '';
    }

    // Event Listeners
    formRegistro.addEventListener('submit', adicionarRegistro);
    btnFilter.addEventListener('click', () => carregarRegistros());
    exportAllBtn.addEventListener('click', exportarExcelCompleto);

    // Inicializa tabela
    carregarRegistros();
  </script>
</body>
</html>

